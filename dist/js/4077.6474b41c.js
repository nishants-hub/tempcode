"use strict";(self.webpackChunkconstruction_commercial_search_frontend=self.webpackChunkconstruction_commercial_search_frontend||[]).push([[4077],{84077:function(t,e,a){a.r(e),a.d(e,{default:function(){return l}});var i=(a(44114),a(77788)),o=a(78275),s=a(93518),r={props:{companyData:{type:Object,required:!0},marketResearchId:{type:String,required:!0},marketResearchSettings:{type:Object,required:!1},productId:{type:String,required:!1},statusOptions:{type:Array,required:!0}},components:{FormInput:()=>a.e(6342).then(a.bind(a,96342)),GeneralForm:()=>a.e(6277).then(a.bind(a,76277)),GeneralButton:()=>a.e(695).then(a.bind(a,90695)),ProductQuotationSelectModal:()=>a.e(79).then(a.bind(a,30079)),ClassicTable:()=>a.e(440).then(a.bind(a,30440)),IconPlus:()=>a.e(531).then(a.bind(a,80531)),IconInfo:()=>a.e(9794).then(a.bind(a,29794)),IconTrash2:()=>a.e(4956).then(a.bind(a,14956)),GeneralRemovableItem:()=>a.e(7349).then(a.bind(a,57349)),FileActions:()=>a.e(9667).then(a.bind(a,99667)),StatusSearchDropdown:()=>a.e(2936).then(a.bind(a,42936)),SelectProductVariableModal:()=>a.e(1476).then(a.bind(a,11476))},data:()=>({isFormSubmitting:!1,formData:{status:"",date:(0,o.wZ)(0),note:"",followUpDate:""},quotationFileData:[],productPrices:[],quotationHeaders:[{key:"file",value:"File",sortable:!1},{key:"products",value:"Products",sortable:!1},{key:"action",value:"",sortable:!1}],productVariables:{},fieldValidations:{status:new i.s({minLength:2,maxLength:50,required:!0}),updateDate:new i.s({required:!0,type:"DATE",minDate:(0,o.wZ)(0),maxDate:(0,o.wZ)(0)}),note:new i.s({minLength:5,required:!1,maxLength:200}),followUpDate:new i.s({required:!0,type:"DATE",minDate:(0,o.wZ)(0),maxDate:(0,o.wZ)(60)})},deletionList:[]}),mounted(){this.$bus.$on("attach-quotations-to-status-form",(t=>{t&&(this.quotationFileData=t)})),this.$bus.$on("product-variable-selected-new-price",(t=>{t?.index&&t?.variable&&t?.product&&this.productPrices.splice(t?.index,0,{title:t?.product?.title,price:t?.price||"",dateAdded:t?.dateAdded||(new Date).toISOString().substring(0,10),productId:t?.product?.productId,variableId:t?.variable?.id,_id:`${t?.product?.productId}-${t?.variable?.id||"none"}`,isNew:!0,variableName:t?.variable?.name})})),this.fetchProductsVariables()},watch:{nextFollowUpDate:{immediate:!0,handler:function(){this.formData.followUpDate=this.nextFollowUpDate?this.nextFollowUpDate?.date:""}},productsData:{immediate:!0,handler:function(){this.fetchProductsVariables(),this.initializeProductPrices(),this.setQuotationData()},deep:!0}},computed:{nextFollowUpDate(){return(0,o.My)((0,o.wZ)(0),this.marketResearchSettings?.followUpDateInterval)},productsData(){let t=[];return t=this.productId?this.companyData?.products?.filter((t=>t?.doesCompanySell&&t?.productId===this.productId)):this.companyData?.products?.filter((t=>t?.doesCompanySell)),t=t?.map((t=>({_id:t?.productId,title:t?.productName,quotation:t?.quotation})))||[],t},productVariableOptions(){return this.productVariables&&Object.keys(this.productVariables).length?Object.entries(this.productVariables).reduce(((t,[e,a])=>(t[e]=[...a?.filter((t=>!this.productPrices?.some((e=>e.variableId===t?._id))))?.map((t=>({key:t?._id,value:`${t.name} [${t.coefficient}]`}))),{key:"",value:"Select Variable",default:!0}],t)),{}):{}}},methods:{...(0,s.i0)({getTrackers:"auth/getTrackers",getFileBlob:"utils/getFileBlob",addQuotation:"marketResearch/addQuotation",getProductVariables:"category/getProductVariables"}),checkForQuotationAndPrices(t){const e=t?.map((t=>t?._id)),a=this.quotationFileData?.flatMap((t=>t?.products||[]))||[];t?.forEach((t=>{if(!a.find((e=>e?._id===t?._id)))throw new Error(`Quotation file is required for product: ${t?.title}${t?.variableName?"-":""}${t?.variableName||""}.`)})),a.forEach((t=>{if(!e.includes(t?._id))throw new Error(`Price is required for product: ${t?.title}${t?.variableName?"-":""}${t?.variableName||""}.`)}))},async handleSubmit(){if(!this.$validateForm())return;const t=this.productPrices?.filter((t=>t?.price))?.map((t=>({...t,price:Number(t?.price)})));try{this.checkForQuotationAndPrices(t)}catch(t){return this.$toast.error(t?.message)}const e=new FormData;e.append("marketResearchId",this.marketResearchId),e.append("companyId",this.companyData?.companyId),e.append("followUp",JSON.stringify(this.formData)),e.append("prices",JSON.stringify(t)),e.append("deletionList",JSON.stringify(this.deletionList)),this.quotationFileData?.forEach(((t,a)=>{t?.file?.isLink?e.append(`files[${a}]`,a):e.append(`files[${a}]`,t.file),e.append(`products[${a}]`,JSON.stringify(t.products?.map((t=>t?._id))))})),this.isFormSubmitting=!0;const a=await this.addQuotation(e);a?.success?(this.$bus.$emit("refetch-market-research-details"),this.getTrackers(),this.handleClose()):this.$toast.error(a?.message),this.isFormSubmitting=!1},initializeProductPrices(){this.productPrices=this.productsData?.map((t=>({title:t?.title,price:isNaN(parseInt(t?.quotation?.price))?"":t?.quotation?.price,dateAdded:t?.quotation?new Date(t?.quotation?.dateOfPriceAdded).toISOString().substring(0,10):(new Date).toISOString().substring(0,10),productId:t?._id,variableId:t?.quotation?.variableId?._id?t?.quotation?.variableId?._id:"",isNew:!!isNaN(parseInt(t?.quotation?.price)),variableName:t?.quotation?.variableId?`${t?.quotation?.variableId?.name} [${t?.quotation?.variableId?.coefficient}]`:"default [1]",_id:`${t?._id}-${t?.quotation?.variableId?._id||"none"}`})))},setQuotationData(){const t=this.productsData?.reduce(((t,e)=>{const{quotation:a,_id:i,title:o}=e||{},s=a?.quotationFile;return s&&(t[s]=t[s]||[],t[s].push({productId:i,title:o,variableId:e?.quotation?.variableId?._id?e?.quotation?.variableId?._id:"",variableName:e?.quotation?.variableId?`${e?.quotation?.variableId?.name} [${e?.quotation?.variableId?.coefficient}]`:null,_id:`${i}-${e?.quotation?.variableId?._id||"none"}`})),t}),{});this.quotationFileData=Object.entries(t||{}).map((([t,e])=>({file:{link:t,name:t?.split("/")?.pop(),isLink:!0},products:e})))},async fetchProductsVariables(){const t=this.productsData.map((t=>t?._id));if(!t||0===t?.length)return;const e=await this.getProductVariables({params:{productIds:t}});e?.success&&(this.productVariables=e?.data)},addNewVariablePrice(t,e){this.$bus.$emit("select-product-variable-modal",{showModal:!0,selectOptions:this.productVariableOptions[t?.productId],index:e,product:t})},handleClose(){this.$bus.$emit("research-status-modal",!1)},openProductQuotationSelectModal(){this.$bus.$emit("product-quotation-select-modal",{showModal:!0,products:[...this.productPrices],quotationFiles:[...this.quotationFileData]})},removeQuotation(t){this.quotationFileData.splice(t,1)},removeProductQuotation(t){this.quotationFileData=this.quotationFileData.map((e=>({...e,products:e.products?.filter((e=>e?._id!==t?._id))})))?.filter((t=>t?.products?.length>0))},updateStatus(t){this.formData.status=t?.display_name},removeVariablePrice(t,e){this.product?.isNew||this.deletionList.push({productId:t?.productId,variableId:t?.variableId}),this.productPrices?.splice(e,1),this.removeProductQuotation(t)}},beforeDestroy(){this.$bus.$off("attach-quotations-to-status-form"),this.$bus.$off("product-variable-selected-new-price")}},n=r,d=(0,a(81656).A)(n,(function(){var t=this,e=t._self._c;return e("div",{staticClass:"h-full w-full"},[e("GeneralForm",{attrs:{heading:"STATUS UPDATE","sub-heading":t.companyData?.companyName||"Unknown Company",showCloseButton:!0,"submit-button-label":"Confirm","is-form-submitting":t.isFormSubmitting},on:{"close-pressed":t.handleClose,"form-submitted":t.handleSubmit},scopedSlots:t._u([{key:"form-body",fn:function(){return[e("div",{staticClass:"flex flex-col gap-spacing-200"},[t.nextFollowUpDate?.shifted?e("div",{staticClass:"mb-spacing-100 flex items-center gap-spacing-100 rounded-08 border border-stroke-info bg-bg-status-info px-spacing-200 py-spacing-100"},[e("IconInfo",{staticClass:"h-spacing-200 w-spacing-200 text-content-on-status-on-info"}),e("p",{staticClass:"text-body/m/relaxed/400 text-content-on-status-on-info"},[t._v(" The follow-up date has been shifted by "+t._s(1===t.nextFollowUpDate?.shifted?"one":"two")+" "+t._s(1===t.nextFollowUpDate?.shifted?"day":"days")+". ")])],1):t._e(),e("div",{staticClass:"flex flex-col gap-spacing-200 ipadPro:flex-row"},[e("div",{staticClass:"flex w-full flex-col gap-spacing-100 py-spacing-50 ipadPro:sticky ipadPro:top-spacing-0 ipadPro:w-1/3 ipadPro:self-start"},[e("StatusSearchDropdown",{ref:"status",staticClass:"my-spacing-100",attrs:{"dropdown-label":"Status","dropdown-id":"status",selectedStatus:{display_name:t.formData?.status},"is-multi-select":!1,"field-validations":t.fieldValidations?.status,order:1,"status-options":t.statusOptions},on:{"on-status-update":t.updateStatus}}),e("FormInput",{ref:"updateDate",attrs:{label:"Update Date","input-id":"updateDate","input-type":"date","field-validations":t.fieldValidations?.updateDate,order:2},on:{"enter-pressed":function(e){return t.$focusNextElement("updateNotes")}},model:{value:t.formData.date,callback:function(e){t.$set(t.formData,"date",e)},expression:"formData.date"}}),e("FormInput",{ref:"note",attrs:{label:"Update/Notes","input-id":"updateNotes",placeholder:"Type your notes...",multiline:!0,"field-validations":t.fieldValidations?.note,order:3},model:{value:t.formData.note,callback:function(e){t.$set(t.formData,"note",e)},expression:"formData.note"}}),e("FormInput",{ref:"followUpDate",attrs:{label:"Follow-up Date","input-id":"followUpDate","input-type":"date","field-validations":t.fieldValidations?.followUpDate,order:4},on:{"enter-pressed":function(e){return t.$focusNextElement("price-0")}},model:{value:t.formData.followUpDate,callback:function(e){t.$set(t.formData,"followUpDate",e)},expression:"formData.followUpDate"}})],1),e("div",{staticClass:"border-r border-t border-stroke-bold"}),e("div",{staticClass:"flex w-full flex-col gap-spacing-100 ipadPro:w-2/3"},[e("p",{staticClass:"mb-spacing-100 border-b border-stroke-bold pb-spacing-100 text-center text-overline/m/relaxed/500 text-content-on-neutral-secondary"},[t._v(" ADD PRICES ")]),t._l(t.productPrices,(function(a,i){return e("div",{key:i},[e("div",{staticClass:"flex flex-col gap-spacing-100"},[e("div",{staticClass:"flex items-center gap-spacing-100 text-body/m/relaxed/400 text-content-on-neutral-secondary"},[e("span",[t._v(t._s(a?.title)+" - "+t._s(a?.variableName))]),!a?.variableId&&t.productVariableOptions?.[a?.productId]?.length>1?e("div",{staticClass:"flex h-spacing-250 w-spacing-250 cursor-pointer items-center justify-center rounded-full bg-constant-brand-primary hover:bg-hover-constant-brand-primary",attrs:{tabindex:"0"},on:{click:function(e){return t.addNewVariablePrice(a,i+1)}}},[e("IconPlus",{staticClass:"h-spacing-200 w-spacing-200 text-content-on-neutral-primary"})],1):t._e()]),e("div",{staticClass:"grid grid-cols-1 gap-x-spacing-100 gap-y-spacing-100 ipadPro:grid-cols-2"},[e("FormInput",{attrs:{label:"Price","input-id":`price-${i}`,"input-type":"number"},model:{value:a.price,callback:function(e){t.$set(a,"price",e)},expression:"product.price"}}),e("div",{staticClass:"flex items-center gap-spacing-100"},[e("FormInput",{attrs:{label:"Date","input-id":`date-${i}`,"input-type":"date"},model:{value:a.dateAdded,callback:function(e){t.$set(a,"dateAdded",e)},expression:"product.dateAdded"}}),e("div",{staticClass:"mb-spacing-300 ml-spacing-100 cursor-pointer",on:{click:function(e){return t.removeVariablePrice(a,i)}}},[e("IconTrash2",{staticClass:"h-spacing-200 w-spacing-200 text-content-on-neutral-secondary hover:text-constant-status-error"})],1)],1)],1)])])})),e("div",{staticClass:"mb-spacing-200 flex"},[e("div",{on:{click:t.openProductQuotationSelectModal}},[e("GeneralButton",{attrs:{"button-type":"button",type:"brand",size:"small",emphasis:"secondary","icon-position":"none",label:t.quotationFileData?.length>0?"Manage Uploaded Quotations":"Upload Quotation"}})],1)]),t.quotationFileData?.length>0?e("p",{staticClass:"border-b border-stroke-medium py-spacing-100 text-body/l/relaxed/400 text-content-on-neutral-primary"},[t._v(" Attached Quotation Files: ")]):t._e(),t.quotationFileData?.length>0?e("ClassicTable",{staticClass:"mt-spacing-200",attrs:{headers:t.quotationHeaders,"horizontal-padding":"px-spacing-0",bgClass:"bg-transparent"},scopedSlots:t._u([{key:"table-body",fn:function(){return t._l(t.quotationFileData,(function(a,i){return e("tr",{key:i,staticClass:"border-b border-stroke-medium text-left text-body/m/relaxed/400 text-content-on-neutral-primary"},[e("td",{staticClass:"max-w-[200px] py-spacing-100 pr-spacing-100",class:a?.file?.isLink?"text-content-on-neutral-tertiary":"text-content-on-neutral-primary"},[e("p",[t._v(" "+t._s(a?.file?.name)+" "),a?.file?.isLink?t._e():e("span",{staticClass:"ml-spacing-50 rounded-04 bg-bg-status-success px-spacing-50 py-spacing-0 text-overline/s/relaxed/500 text-content-on-status-on-success"},[t._v(" NEW ")])])]),e("td",{staticClass:"py-spacing-100 pr-spacing-100"},[e("div",{staticClass:"flex flex-wrap items-center gap-spacing-50"},t._l(a?.products,(function(i){return e("div",{key:i?._id,staticClass:"text-content-on-neutral-primary"},[e("GeneralRemovableItem",{attrs:{"item-name":`${i?.title} - ${i?.variableName||"default[1]"}`,"is-disabled":a?.file?.isLink},on:{"on-item-removed":function(e){return t.removeProductQuotation(i)}}})],1)})),0)]),e("td",{staticClass:"py-spacing-100 pr-spacing-100"},[e("FileActions",{attrs:{file:a?.file},on:{remove:function(e){return t.removeQuotation(i)}}})],1)])}))},proxy:!0}],null,!1,3324267438)}):t._e()],2)])])]},proxy:!0}])}),e("ProductQuotationSelectModal"),e("SelectProductVariableModal")],1)}),[],!1,null,null,null),l=d.exports}}]);